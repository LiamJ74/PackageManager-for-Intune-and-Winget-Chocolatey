<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Package Manager for Intune</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }
        
        .badge {
            background: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 64px);
        }
        
        .main {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .console {
            width: 384px;
            background: #0f172a;
            border-left: 1px solid #334155;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .console-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .console-content {
            flex: 1;
            background: #020617;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
        }
        
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-description {
            color: #94a3b8;
            margin-bottom: 20px;
        }
        
        .search-container {
            display: flex;
            gap: 12px;
        }
        
        .input {
            flex: 1;
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .select {
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn:disabled {
            background: #475569;
            cursor: not-allowed;
        }
        
        .package-item {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .package-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .package-item.winget {
            border-color: #3b82f6;
            background: #1e3a8a;
        }
        
        .package-item.chocolatey {
            border-color: #f97316;
            background: #7c2d12;
        }
        
        .package-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .package-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .package-description {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .package-details {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #94a3b8;
        }
        
        .source-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .source-badge.winget {
            background: #3b82f6;
            color: white;
        }
        
        .source-badge.chocolatey {
            background: #f97316;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-icon {
            width: 64px;
            height: 64px;
            background: #16a34a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
        
        .text-center {
            text-align: center;
        }
        
        .space-y-4 > * + * {
            margin-top: 16px;
        }
        
        .space-y-6 > * + * {
            margin-top: 24px;
        }
        
        .checkbox-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .checkbox {
            width: 16px;
            height: 16px;
        }
        
        .textarea {
            width: 100%;
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .console-line {
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .console-line.error {
            color: #ef4444;
        }
        
        .console-line.success {
            color: #16a34a;
        }
        
        .console-line.info {
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">P</div>
            <div class="logo-text">Package Manager for Intune</div>
            <div class="badge">Desktop App</div>
        </div>
        <div id="connection-status">
            <button id="connect-btn" class="btn">
                üîí Se connecter √† Intune
            </button>
        </div>
    </header>

    <div class="container">
        <main class="main" id="main-content">
            <!-- Content will be dynamically inserted here -->
        </main>

        <div class="console">
            <div class="console-header">
                <div class="console-title">
                    üíª Console
                </div>
                <button id="clear-console" class="btn" style="padding: 8px 16px; font-size: 12px;">
                    Effacer
                </button>
            </div>
            <div class="console-content" id="console-output">
                <div class="console-line info">Pr√™t...</div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        class PackageManager {
            constructor() {
                this.state = {
                    searchQuery: '',
                    searchResults: [],
                    selectedPackage: null,
                    isSearching: false,
                    currentStep: 'search',
                    generatedScript: '',
                    isConnected: false,
                    searchSource: 'both',
                    consoleOutput: ['Pr√™t...']
                };
                this.init();
            }

            init() {
                this.render();
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('search-btn').addEventListener('click', () => this.handleSearch());
                document.getElementById('connect-btn').addEventListener('click', () => this.handleConnect());
                document.getElementById('deploy-btn').addEventListener('click', () => this.handleDeploy());
                document.getElementById('new-deployment-btn').addEventListener('click', () => this.reset());
                document.getElementById('clear-console').addEventListener('click', () => this.clearConsole());
                
                document.getElementById('search-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleSearch();
                });
                
                document.getElementById('search-source').addEventListener('change', (e) => {
                    this.state.searchSource = e.target.value;
                });
            }

            addConsoleOutput(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const prefix = type === 'error' ? '[ERREUR]' : type === 'success' ? '[SUCC√àS]' : '[INFO]';
                this.state.consoleOutput.push(`${timestamp} ${prefix} ${message}`);
                this.updateConsole();
            }

            updateConsole() {
                const consoleDiv = document.getElementById('console-output');
                consoleDiv.innerHTML = this.state.consoleOutput.map(line => {
                    const type = line.includes('[ERREUR]') ? 'error' : 
                                line.includes('[SUCC√àS]') ? 'success' : 'info';
                    return `<div class="console-line ${type}">${line}</div>`;
                }).join('');
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            clearConsole() {
                this.state.consoleOutput = ['Console effac√©e...'];
                this.updateConsole();
            }

            async handleSearch() {
                if (!this.state.searchQuery.trim()) return;
                
                this.state.isSearching = true;
                this.state.currentStep = 'search';
                this.state.consoleOutput = [];
                this.addConsoleOutput(`Recherche de: "${this.state.searchQuery}"`);
                this.render();

                try {
                    const results = [];
                    
                    if (this.state.searchSource === 'both' || this.state.searchSource === 'winget') {
                        this.addConsoleOutput('Recherche avec Winget...');
                        try {
                            const wingetResults = await ipcRenderer.invoke('search-winget', this.state.searchQuery);
                            results.push(...wingetResults);
                            this.addConsoleOutput(`Trouv√© ${wingetResults.length} packages avec Winget`, 'success');
                        } catch (error) {
                            this.addConsoleOutput(`Erreur Winget: ${error}`, 'error');
                        }
                    }
                    
                    if (this.state.searchSource === 'both' || this.state.searchSource === 'chocolatey') {
                        this.addConsoleOutput('Recherche avec Chocolatey...');
                        try {
                            const chocoResults = await ipcRenderer.invoke('search-chocolatey', this.state.searchQuery);
                            results.push(...chocoResults);
                            this.addConsoleOutput(`Trouv√© ${chocoResults.length} packages avec Chocolatey`, 'success');
                        } catch (error) {
                            this.addConsoleOutput(`Erreur Chocolatey: ${error}`, 'error');
                        }
                    }
                    
                    results.sort((a, b) => {
                        if (a.source === 'winget' && b.source !== 'winget') return -1;
                        if (a.source !== 'winget' && b.source === 'winget') return 1;
                        return 0;
                    });
                    
                    this.state.searchResults = results;
                    this.addConsoleOutput(`Total: ${results.length} packages trouv√©s`, 'success');
                } catch (error) {
                    this.addConsoleOutput(`Erreur lors de la recherche: ${error}`, 'error');
                }
                
                this.state.isSearching = false;
                this.render();
            }

            handleSelectPackage(pkg) {
                this.state.selectedPackage = pkg;
                this.state.currentStep = 'configure';
                this.generateScript(pkg);
                this.addConsoleOutput(`Package s√©lectionn√©: ${pkg.name} (${pkg.source})`);
                this.render();
            }

            generateScript(pkg) {
                const template = pkg.source === 'winget' ? 
`# ============================================================
# Winget-Install Intune Win32 App ‚Äì TEMPLATE
# Package: ${pkg.name}
# ID: ${pkg.id}
# Version: ${pkg.version}
# ============================================================

# Cr√©e le dossier de log si inexistant
$LogFolder = "C:\\ProgramData\\Autopilot-Setup"
if (-not (Test-Path -Path $LogFolder)) {
    New-Item -ItemType Directory -Path $LogFolder -Force | Out-Null
}

# D√©finit le chemin du script WAU
$WUAScript = "C:\\Program Files\\Winget-Autoupdate-aaS\\Winget-AutoUpdate\\Winget-Install.ps1"

# V√©rifie que le script existe
if (-not (Test-Path $WUAScript)) {
    Write-Output "ERROR: Winget-Install.ps1 not found at $WUAScript"
    exit 1
}

# AppID √† installer
$AppID = '${pkg.id}'

# Ex√©cution du script WAU avec bypass
try {
    Start-Process -FilePath "$env:WINDIR\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" -ArgumentList @(
        "-ExecutionPolicy", "Bypass",
        "-NoProfile",
        "-File", $WUAScript,
        "-AppIDs", $AppID,
        "-LogPath", $LogFolder
    ) -Wait -PassThru | Out-Null

    if ($LASTEXITCODE -ne 0) {
        Write-Output "ERROR: Winget-Install.ps1 returned exit code $LASTEXITCODE"
        exit $LASTEXITCODE
    }
}
catch {
    Write-Output "ERROR: Exception caught - $_"
    exit 1
}

exit 0` :
`# ============================================================
# Chocolatey-Install Intune Win32 App ‚Äì TEMPLATE
# Package: ${pkg.name}
# ID: ${pkg.id}
# Version: ${pkg.version}
# ============================================================

# Cr√©e le dossier de log si inexistant
$LogFolder = "C:\\ProgramData\\Autopilot-Setup"
if (-not (Test-Path -Path $LogFolder)) {
    New-Item -ItemType Directory -Path $LogFolder -Force | Out-Null
}

# Chemin de Chocolatey
$ChocoPath = "C:\\ProgramData\\chocolatey\\choco.exe"

# V√©rifie que Chocolatey est install√©
if (-not (Test-Path $ChocoPath)) {
    Write-Output "ERROR: Chocolatey not found at $ChocoPath"
    exit 1
}

# Package ID √† installer
$PackageID = '${pkg.id}'

# Ex√©cution de l'installation Chocolatey
try {
    Start-Process -FilePath "$env:WINDIR\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" -ArgumentList @(
        "-ExecutionPolicy", "Bypass",
        "-NoProfile",
        "-Command", "& $ChocoPath install $PackageID -y --log-file='$LogFolder\\choco-install.log'"
    ) -Wait -PassThru | Out-Null

    if ($LASTEXITCODE -ne 0) {
        Write-Output "ERROR: Chocolatey installation failed with exit code $LASTEXITCODE"
        exit $LASTEXITCODE
    }
}
catch {
    Write-Output "ERROR: Exception caught - $_"
    exit 1
}

exit 0`;
                
                this.state.generatedScript = template;
            }

            async handleDeploy() {
                if (!this.state.selectedPackage) return;
                
                this.state.currentStep = 'deploy';
                this.addConsoleOutput('D√©but du d√©ploiement sur Intune...');
                this.render();
                
                try {
                    const filename = `${this.state.selectedPackage.id}_install.ps1`;
                    const saveResult = await ipcRenderer.invoke('save-script', this.state.generatedScript, filename);
                    
                    if (saveResult.success) {
                        this.addConsoleOutput(`Script sauvegard√©: ${saveResult.filePath}`, 'success');
                        
                        const config = {
                            appId: this.state.selectedPackage.id,
                            version: this.state.selectedPackage.version,
                            source: this.state.selectedPackage.source,
                            targetGroups: [],
                            silentInstall: true,
                            autoUpdate: true,
                            requirements: 'Windows 10 1809+'
                        };
                        
                        const deployResult = await ipcRenderer.invoke('deploy-to-intune', config, this.state.generatedScript);
                        
                        if (deployResult.success) {
                            this.addConsoleOutput('D√©ploiement r√©ussi sur Intune!', 'success');
                            this.state.currentStep = 'success';
                        } else {
                            this.addConsoleOutput('√âchec du d√©ploiement sur Intune', 'error');
                            this.state.currentStep = 'configure';
                        }
                    }
                } catch (error) {
                    this.addConsoleOutput(`Erreur lors du d√©ploiement: ${error}`, 'error');
                    this.state.currentStep = 'configure';
                }
                
                this.render();
            }

            handleConnect() {
                this.state.isConnected = true;
                this.addConsoleOutput('Connexion √† Intune √©tablie', 'success');
                this.render();
            }

            reset() {
                this.state.searchQuery = '';
                this.state.searchResults = [];
                this.state.selectedPackage = null;
                this.state.currentStep = 'search';
                this.state.generatedScript = '';
                this.state.consoleOutput = ['Pr√™t...'];
                this.render();
            }

            render() {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = this.getMainContent();
                
                // Update connection status
                const connectionStatus = document.getElementById('connection-status');
                if (this.state.isConnected) {
                    connectionStatus.innerHTML = '<div style="color: #16a34a; display: flex; align-items: center; gap: 8px;">‚úÖ Connect√© √† Intune</div>';
                } else {
                    connectionStatus.innerHTML = '<button id="connect-btn" class="btn">üîí Se connecter √† Intune</button>';
                    document.getElementById('connect-btn').addEventListener('click', () => this.handleConnect());
                }
                
                // Re-attach event listeners for package items
                document.querySelectorAll('.package-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const pkg = JSON.parse(item.dataset.package);
                        this.handleSelectPackage(pkg);
                    });
                });
            }

            getMainContent() {
                if (this.state.currentStep === 'search') {
                    return `
                        <div class="space-y-6">
                            <div class="card">
                                <div class="card-title">
                                    üîç Rechercher un package
                                </div>
                                <div class="card-description">
                                    Recherchez des applications avec Winget et Chocolatey
                                </div>
                                <div class="search-container">
                                    <input
                                        id="search-input"
                                        type="text"
                                        placeholder="Tapez le nom d'une application (ex: Acrobat Reader, VS Code...)"
                                        value="${this.state.searchQuery}"
                                        onchange="app.state.searchQuery = this.value"
                                        class="input"
                                    />
                                    <select id="search-source" class="select">
                                        <option value="both">Les deux</option>
                                        <option value="winget">Winget</option>
                                        <option value="chocolatey">Chocolatey</option>
                                    </select>
                                    <button id="search-btn" class="btn" ${!this.state.searchQuery.trim() || this.state.isSearching ? 'disabled' : ''}>
                                        ${this.state.isSearching ? '<div class="spinner"></div>' : 'üîç'}
                                    </button>
                                </div>
                            </div>

                            ${this.state.searchResults.length > 0 ? `
                                <div class="card">
                                    <div class="card-title">R√©sultats de recherche</div>
                                    <div>
                                        ${this.state.searchResults.map(pkg => `
                                            <div class="package-item ${pkg.source}" data-package='${JSON.stringify(pkg)}'>
                                                <div class="package-header">
                                                    <div>
                                                        <div class="package-name">${pkg.name}</div>
                                                        <div class="package-description">${pkg.description}</div>
                                                        <div class="package-details">
                                                            <span>ID: <code>${pkg.id}</code></span>
                                                            <span>Version: ${pkg.version}</span>
                                                            ${pkg.publisher ? `<span>√âditeur: ${pkg.publisher}</span>` : ''}
                                                        </div>
                                                    </div>
                                                    <span class="source-badge ${pkg.source}">${pkg.source}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                if (this.state.currentStep === 'configure' && this.state.selectedPackage) {
                    return `
                        <div class="grid">
                            <div class="card">
                                <div class="card-title">üì¶ R√©sum√© du package</div>
                                <div class="space-y-4">
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <div style="width: 64px; height: 64px; background: #475569; border: 2px dashed #64748b; border-radius: 12px;"></div>
                                        <div>
                                            <div style="font-weight: 600; font-size: 18px;">${this.state.selectedPackage.name}</div>
                                            <div style="color: #94a3b8;">${this.state.selectedPackage.description}</div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #94a3b8;">ID du package:</span>
                                            <code style="background: #334155; padding: 4px 8px; border-radius: 4px;">${this.state.selectedPackage.id}</code>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #94a3b8;">Version:</span>
                                            <span style="font-weight: 500;">${this.state.selectedPackage.version}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #94a3b8;">Source:</span>
                                            <span style="font-weight: 500; color: ${this.state.selectedPackage.source === 'winget' ? '#3b82f6' : '#f97316'}">${this.state.selectedPackage.source}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-title">‚öôÔ∏è Configuration du d√©ploiement</div>
                                <div class="space-y-4">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Groupes cibles</label>
                                        <select class="input">
                                            <option>S√©lectionner les groupes</option>
                                            <option value="all-users">Tous les utilisateurs</option>
                                            <option value="it-dept">D√©partement IT</option>
                                            <option value="sales">√âquipe commerciale</option>
                                            <option value="dev">D√©veloppeurs</option>
                                        </select>
                                    </div>
                                    
                                    <div class="checkbox-container">
                                        <label style="font-weight: 500;">Installation silencieuse</label>
                                        <input type="checkbox" checked class="checkbox">
                                    </div>
                                    <div class="checkbox-container">
                                        <label style="font-weight: 500;">Mises √† jour automatiques</label>
                                        <input type="checkbox" checked class="checkbox">
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Configuration requise</label>
                                        <textarea rows="3" class="textarea">Windows 10 1809+</textarea>
                                    </div>

                                    <button id="deploy-btn" class="btn" style="width: 100%;">
                                        üì§ D√©ployer sur Intune
                                    </button>
                                </div>
                            </div>

                            <div style="grid-column: 1 / -1;" class="card">
                                <div class="card-title">üìÑ Script d'installation g√©n√©r√©</div>
                                <textarea readonly rows="20" class="textarea">${this.state.generatedScript}</textarea>
                            </div>
                        </div>
                    `;
                }

                if (this.state.currentStep === 'deploy') {
                    return `
                        <div class="card">
                            <div class="text-center space-y-4">
                                <div style="width: 64px; height: 64px; border: 4px solid #3b82f6; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                <div style="font-size: 20px; font-weight: 600;">D√©ploiement en cours...</div>
                                <div style="color: #94a3b8;">
                                    Cr√©ation de l'application dans Intune et upload des fichiers
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (this.state.currentStep === 'success') {
                    return `
                        <div class="card">
                            <div class="text-center space-y-6">
                                <div class="success-icon">‚úÖ</div>
                                <div>
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">D√©ploiement r√©ussi!</div>
                                    <div style="color: #94a3b8;">
                                        L'application a √©t√© ajout√©e √† Intune avec succ√®s
                                    </div>
                                </div>
                                <div style="background: #334155; border-radius: 8px; padding: 16px; text-align: left; max-width: 400px; margin: 0 auto;">
                                    <div style="font-weight: 600; margin-bottom: 8px;">D√©tails du d√©ploiement:</div>
                                    <div style="font-size: 14px; color: #e2e8f0; space-y: 1;">
                                        <div>Application: ${this.state.selectedPackage.name}</div>
                                        <div>ID: ${this.state.selectedPackage.id}</div>
                                        <div>Version: ${this.state.selectedPackage.version}</div>
                                        <div>Source: ${this.state.selectedPackage.source}</div>
                                    </div>
                                </div>
                                <button id="new-deployment-btn" class="btn" style="margin: 0 auto;">
                                    üì¶ D√©ployer une autre application
                                </button>
                            </div>
                        </div>
                    `;
                }

                return '';
            }
        }

        // Initialize app
        const app = new PackageManager();
    </script>
</body>
</html>